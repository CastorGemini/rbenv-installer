#!/usr/bin/env bash
# Summary: Install as a rbenv plugin the repository ($1) of the github user ($2).
#
# Usage: rbenv plugin <github_user>:<github_repo>
#        rbenv plugins <github_user_a>:<github_repo_a> <github_user_b>:<github_repo_b> ...
#
# Installs the Github user's repository branch $RBENV_PLUGIN_BRANCH (default is
# master) as the rbenv plugin.
#
# The GitHub repository name is used as the rbenv plugin name.
#
# If you want to install from an specific branch:
#
#    export RBENV_PLUGIN_BRANCH=develop
#    rbenv plugin abc:xyz
#

set -e
[ -n "$RBENV_DEBUG" ] && set -x

if [ -z "${RBENV_ROOT}" ]; then
  RBENV_ROOT="$HOME/.rbenv"
fi

# If the user hasn't specified which rbenv-plugin branch
# to install, we default to the master branch
if [ "x$RBENV_PLUGIN_BRANCH" = "x" ]; then
  RBENV_PLUGIN_BRANCH=master
fi

# Install plugins:
PLUGINS=("$@")

for plugin in ${PLUGINS[@]} ; do

  AUTHOR=${plugin%%:*}
  PLUGIN=${plugin#*:}

  RBENV_PLUGIN_ROOT="${RBENV_ROOT}/plugins/$PLUGIN"
  if [ ! -d "$RBENV_PLUGIN_ROOT" ] ; then
    # Keep downloads lean and installs fast - grab ONLY the branch we need.
    mkdir -p $RBENV_PLUGIN_ROOT
    cd $RBENV_PLUGIN_ROOT
    git init
    git remote add --no-tags origin https://github.com/$AUTHOR/$PLUGIN.git
    git remote set-url --push origin disabled
    git fetch --no-tags --depth=1 origin +$RBENV_PLUGIN_BRANCH:refs/remotes/origin/$RBENV_PLUGIN_BRANCH
    git checkout $RBENV_PLUGIN_BRANCH
  else
    cd $RBENV_PLUGIN_ROOT
    git pull --no-tags --depth=1 origin +$RBENV_PLUGIN_BRANCH:refs/remotes/origin/$RBENV_PLUGIN_BRANCH
  fi

done
